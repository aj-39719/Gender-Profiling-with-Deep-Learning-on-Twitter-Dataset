# -*- coding: utf-8 -*-
"""data_preprocessing.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1m2dGCvUIKpVh3i6iRyi1c9Y3JC970tZj
"""

from google.colab import drive, files
drive.mount('/content/drive')

import os
import xml.etree.ElementTree as ET
import pandas as pd
import numpy as np

def create_dataset(language, dataset):
  """
    Create Silver Dataset from Bronze.
    language: String. en, pr, es, ar.
    dataset:String. training or test
  """


  path = f'drive/MyDrive/Project/Bronze/pan17-author-profiling-{dataset}-dataset/{language}/'
  df_tweets = pd.DataFrame()
  authors = []

  # Get Tweets and Authors
  for filename in os.listdir(path):

    if filename.split(".")[1] == 'txt': continue

    # Open XML files
    parser = ET.XMLParser(encoding="utf-8")
    xml_data = open(path+'/'+filename, 'r').read()
    root = ET.XML(xml_data)
    data = []

    # Get information from XML tree
    for i, child in enumerate(root):  
        data.append([subchild.text for subchild in child])
    df_author = pd.DataFrame()
    df_author['author'] = [filename.split(".")[0] for i in range(100)]
    df_author['tweet']= pd.DataFrame(data).T  

    authors.append(df_author)

  df_tweets = pd.concat(authors)


  # Get Labels
  df_labels = pd.read_csv(path+'/truth.txt', sep=":::", header=None, names=['author','sex','country'])


  #Define final data frame
  df = pd.DataFrame()
  df["lan"] = language
  df = df_tweets.join(df_labels.set_index('author'), on="author")[["author","tweet","sex"]]
  df["label"] = np.where(df['sex']=='female', 1, 0)
  print(df.shape)
  with open(f'drive/MyDrive/Project/Bronze/data/{dataset}-dataset-{language}.csv', 'w', encoding = 'utf-8-sig') as f:
    df.to_csv(f,index=False)

for language in ["es","pt","ar","en"]:
  create_dataset(language, "test")
  create_dataset(language, "training")
